---
title: "Coronavirus disease in Qatar"
description: |
  The performance of a high income country in response to COVID-19 pandemic
author:
  - name: Yanhui LI
date: 09-11-2021
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tab.align = "center",
                      fig.align = "center",
                      echo = FALSE)

library(dplyr)
library(tidyr)
library(plotly)
library(ggplot2)
library(scales)
library(tidyverse)
library(naniar)

library(DT)
library(lubridate)
library(plotly)
library(sparkline)
library(formattable)
library(viridis)
library(hrbrthemes)
```

# Data Description
```{r}
library(tidycovid19)
#df2 <- download_merged_data(cached = TRUE, silent = TRUE): save to csv to easy knit
#write_csv(df2,(here::here("/Users/yanhuili/Desktop/blog-yli807/df2.csv")))
df2 <- read_csv(here::here("/Users/yanhuili/Desktop/blog-yli807/df2.csv"))
```

Three data sets are used in this second blog post to illustrate the COVID-19 situation in Qatar. One is from *tidycovid19* package by Joachim Gassen, and other two are collected and maintained by *Our World in Data*, in a completely open access under the Creative Commons BY license. 

As the original datasets are large and messy, the following tables will only show the datasets that have already be cleaned and remained the data related to Qatar, which is the main observation country in this blog post.

From *tidycovid19* package:
 
- *qatdf*

| variable      | class         | description                                                    |                       
|:------------- |:--------------|:-------------------------------------------------------------- |
| iso3c         | char          | ISO3c country code as defined by ISO 3166-1 alpha-3            |
| country       | char          | Country name                                                   |
| date          | Date          | Calendar date                                                  |
| confirmed     | num           | Confirmed Covid-19 cases as reported by JHU CSSE (accumulated) |
| deaths        | num           | Covid-19-related deaths as reported by JHU CSSE (accumulated)  |
| recovered     | num           | Covid-19 recoveries as reported by JHU CSSE (accumulated)      |
| year          | num           | Calendar date of year                                          |
| month         | num           | Calendar date of month                                         |


From *Our World in Data* :

- *dailyvac*

| variable                              | class  | description                                                           |                       
|:------------------------------------- |:-------|:--------------------------------------------------------------------- |
| Entity                                | char   | Entity name                                                           |
| Code                                  | char   | ISO3c country code as defined by ISO 3166-1 alpha-3                   |
| Day                                   | Date   | Calendar date                                                         |
| new_vaccinations_smoothed_per_million | num    | New confirmed cases of COVID-19 (7-day smoothed) per 1,000,000 people |

- *qatvac*

| variable      | class | description                                                                                    |                       
|:------------- |:------|:---------------------------------------------------------------------------------------------- |
| date          | Date  | Date of observation                                                                            |
| Vaccinated    | factor| Total vaccination doses administered ; Received at least one vaccine dose; Received all doses prescribed by the vaccination protocol |
| Count         | num   | Number of Vaccinated variable                                                         |


# Data Exploration

Qatar, officially the State of Qatar, is the third-highest GDP per capita in the world, and it has a high standard of living, with many social benefits available to its citizens.

```{r}
knitr::include_graphics("images/Qatartopview.jpeg")
```

However, Qatar is not a 'big' country from geographically. It occupies the small Qatar Peninsula on the northeastern coast of the Arabian Peninsulaw with only 11,581 km². The reason why Qatar became wealthy is because of the discovery of oil reserves in the 1940s. The entire economy of Qatar is completely changed from then and now Qatar owns one of the world's largest reserves of oil and natural gas.

```{r}
knitr::include_graphics("images/QatarMap.jpeg")
```



## Qatar performance in the Table 2 of [post 1](https://etc5523-2021.github.io/blog-yli807/posts/2021-09-02-coronavirus-disease-in-egypt/) 🇶🇦

From the previous analysis of Egypt, we can see that in the region of Middle East & North Africa,  Qatar is ranking the first place in GDP per capita, and the rate of deaths due to COVID-19 is ranking 21 out of 21 with 0.259%, which means Qatar has the lowest death rate in this region.

According WHO, a positive rate of less than 5% is one indicator that the epidemic is under control in a country. Therefore, to better understand the COVID-19 situation in Qatar, Table \@ref(tab:post1table) also include the positive rate of testing, which is only 0.037% and demonstrates that Qatar is able to control COVID-19 within its country.


```{r post1table,layout = "l-body-outset"}
post1table <- df2 %>% 
  filter(date == "2021-08-30") %>% 
  filter(region == "Middle East & North Africa") %>% 
  select(c(`country`,`confirmed`,`deaths`,`gdp_capita`,`income`,`positive_rate`)) %>% 
  mutate(confirmed = as.double(confirmed),
         deathRate = (deaths/confirmed)*100) %>% 
  relocate(deathRate, .before = gdp_capita) %>%
  arrange(desc(confirmed)) 

post1table$gdp_capita[19]<-2807.0000
post1table$gdp_capita[20]<-1343.2700

post1df <- post1table %>% 
  select(-`deaths`) %>% 
  mutate(Rank = 1:nrow(post1table)) %>% 
  relocate(Rank, .before = country) %>% 
  mutate(deathRank = order(order(deathRate, decreasing = T))) %>% 
  relocate(deathRank, .before = gdp_capita) %>%
  mutate(gdpRank = order(order(gdp_capita, decreasing = T))) %>% 
  select(-`gdp_capita`) %>% 
  relocate(income, .after = gdpRank) %>% 
  rename(IncomeLevel = `income`) %>% 
  mutate(across(is.numeric, ~round(.,3))) 

post1df$IncomeLevel <- gsub("income","",as.character(post1df$IncomeLevel))

formattable(post1df[16,], list(
    Rank = color_tile("transparent", "#7c7ed6"),
    deathRank = color_tile("transparent", "lightpink"),
    positive_rate = color_tile("transparent", "#7DCEA0"),
    gdpRank = color_tile("transparent", "#aedff2")
    ),
    align = "c",
    caption = "Qatar data in post 1")

```


## Overall trend of COVID-19 in Qatar 📈

The following Figure \@ref(fig:overtrend) give a picture of the trend of Qatar COVID-19 from confirmed, deaths and recovered cases. We can see that overall the confirmed cases is still increasing till now and there were total 232,571 cases on August 30, 2021. However, The recover trend is very close to the confirmed line which is a positive sign that the majority of confirmed people in Qatar were recovered. Compared to the other trends, deaths trend looks like a 'straight' line but there were still 602 people lost their lives in this one of the worst pandemics in history till the lastest updated date of this figure data.

```{r qatdf}
qatdf <- df2 %>% 
  filter(iso3c == "QAT") %>% 
  select(c(iso3c,country,date,confirmed,deaths,recovered,total_tests,region,income))

#write_csv(qatdf,(here::here("/Users/yanhuili/Desktop/blog-yli807/qatdf.csv")))

qatdf <- read_csv(here::here("/Users/yanhuili/Desktop/blog-yli807/qatdf.csv")) %>%
  select(c(iso3c,country,date,confirmed,deaths,recovered)) %>% 
  mutate(date = dmy(date),
         year = year(date),
         month = month(date))
```

```{r overtrend, fig.cap= "Overall trend of Qatar's cumulative COVID-19 cases"}
qatfig <- qatdf %>% 
  select(date,confirmed,deaths,recovered) %>% 
  pivot_longer(cols = c(`confirmed`:`recovered`), names_to = "Cases type", values_to = "Count") %>% 
  ggplot(aes(x = date, y = Count, group = `Cases type`, color = `Cases type`))+ 
  labs(title = "Trend of cumulative COVID-19 cases in Qatar", 
       x = "Date", 
       y = "Cases Count") + 
  geom_line()+ 
  scale_color_manual(values=c("#f57c27","#8f2121","#2fa329"))+
  theme_bw()
ggplotly(qatfig)
```


## Monthly changes of COVID-19 NEW cases 📅

Below is an interactive table that includes the new changes in confirmed, deaths and all recovered cases grouped by year and month from January 2020 to August 2021. It is a very handy table to measure the impact of COVID-19 on Qatar. The sparkline shows that in 2020, COVID-19 cases in Qatar start to increase rapidly in March and only had a slow down trend in July. Confirmed cases are in a uptrend generally in 2021.

To have a look at the daily new cases for each month, you can play around with the sparkline by moving your mouse over it!

```{r monthlyspk, layout = "l-body-outset"}
qatable <- qatdf %>% 
  mutate(new_cases = confirmed - lag(confirmed),
         new_deaths = deaths - lag(deaths),
         daily_recovered = recovered - lag(recovered)
         ) %>% 
  group_by(year,month) %>% 
  summarise(new_cases = spk_chr(new_cases,
                                type = "line"),
            new_deaths = spk_chr(new_deaths,
                                 type = "line"),
            daily_recovered = spk_chr(daily_recovered,
                                 type = "line")
            ) 

datatable(qatable, 
           escape = FALSE,
           filter = 'top',
           caption = "Table 2 : Qatar monthly NEW cases",
            colnames = c("Year","Month", "New Confirmed", "New Deaths", "New recoveries"),
            options = list(lengthMenu = c(10, 25),
              fnDrawCallback = 
            htmlwidgets::JS('function(){HTMLWidgets.staticRender();}'))) %>% 
    spk_add_deps()
```


## Vaccination status in Qatar 💉

Figure \@ref(fig:dailyvac) shows the number of COVID-19 vaccination doses administered per 100 people as rolling 7-day average on September 8,2021. From the figure we can see that to compare with the income level, Qatar is very close to the high income level that not enough 0.1 difference. However, for Egypt that analyzed in the previous post, even less than half of the lower middle income level. It is really sad to know that under the control of capitalism, seems like the rich are more likely to get vaccinated.

(Note that the dose in here is counted as a single dose, and may not equal the total number of people vaccinated)

```{r dailyvac, fig.cap= "Daily dose of COVID-19 vaccine per 100 people" }
dailyvac <- read_csv(here::here("/Users/yanhuili/Desktop/blog-yli807/blog2-dailydoses-percapita.csv"))

dailyvac_qat <- dailyvac %>% 
  select(-Code) %>% 
  filter(Entity %in% c("Qatar",
                       "Egypt",
                       "High income",
                       "Lower middle income")) %>% 
  filter(Day == "2021-09-08")

dailyvacfig <- dailyvac_qat %>% 
  ggplot(aes(x = reorder(Entity,new_vaccinations_smoothed_per_million),
             y = new_vaccinations_smoothed_per_million,
             fill = Entity))+ 
  labs(title = "Daily COVID-19 vaccine doses administered per 100 people",
       subtitle = "Shown is the rolling 7-day average,as on Sep 8, 2021",
       x = "Entity", 
       y = "Administered percentage") + 
  geom_bar(stat = "identity")+ 
  geom_text(aes(label = new_vaccinations_smoothed_per_million),
            hjust = 1.25) +
  scale_fill_manual(values=c("#FFCD00","#00AEC7","#3A5DAE","#6C1D45"))+
  coord_flip()

dailyvacfig +
  theme(legend.position = "bottom",
        legend.direction = "horizontal")
```

Figure \@ref(fig:qatvac) below shows the vaccination status by those who has been partly or fully vaccinated. Partly vaccinated means that a person have received only 1 dose out of 2-dose vaccine protocol and fully vaccinated means they have received all the doses of their vaccine no matter in the vaccine protocol of single-dose one or two-dose (Ritchie et al.,2020).

We can see that people in Qatar got vaccinated from April 29,2021, and 2,218,292 people has already fully vaccinated, account for 48.45% , nearly half of the total number of COVID-19 vaccination doses administered.

As the population of Qatar is 2,930,524, therefore, nearly 76% of total population to have fully received vaccine as of the date of this post been published!

```{r qatvac, fig.cap = "Vaccinations of Qatar"}
owid <- read_csv(here::here("/Users/yanhuili/Desktop/blog-yli807/owid-covid-data.csv"))

qatvac <- owid %>%
  filter(location == "Qatar") %>% 
  select(date,total_vaccinations,people_vaccinated,people_fully_vaccinated) %>% 
  na.omit() %>%
  pivot_longer(cols = c(`total_vaccinations`:`people_fully_vaccinated`), names_to = "Vaccinated", values_to = "Count")

qatvac$Vaccinated <- factor(qatvac$Vaccinated, levels = c("total_vaccinations","people_vaccinated","people_fully_vaccinated"))

qatvacfig <- qatvac %>% 
  ggplot(aes(x = date,
             y = Count,
             fill = Vaccinated)) + 
    geom_area(alpha=0.6 , size=.5, colour="white") +
    scale_fill_viridis(discrete = T) +
    theme_ipsum()+
    ggtitle("Number of people get vaccinated in Qatar")


ggplotly(qatvacfig)
```


# Reference

### Packages

- Bob Rudis (2020). hrbrthemes: Additional Themes, Theme Components and Utilities for 'ggplot2'. R package version 0.8.0. https://CRAN.R-project.org/package=hrbrthemes

- C. Sievert. Interactive Web-Based Data Visualization with R, plotly, and shiny. Chapman and Hall/CRC Florida, 2020.

- Grolemund G, Wickham H (2011). “Dates and Times Made Easy with lubridate.” Journal of Statistical Software, 40(3), 1–25. https://www.jstatsoft.org/v40/i03/.

- H. Wickham. ggplot2: Elegant Graphics for Data Analysis.Springer-Verlag New York, 2016.

- Hadley Wickham (2021). tidyr: Tidy Messy Data. R package version 1.1.3. https://CRAN.R-project.org/package=tidyr

- Hadley Wickham and Dana Seidel (2020). scales: Scale Functions for Visualization. R package version 1.1.1. https://CRAN.R-project.org/package=scales

- Hadley Wickham, Romain François, Lionel Henry and Kirill Müller (2021). dplyr: A Grammar of Data Manipulation. R package version 1.0.7. https://CRAN.R-project.org/package=dplyr

- Joachim Gassen (NA). tidycovid19: Download, Tidy and Visualize Covid-19 Related Data. R package version 0.0.0.9000.

- Kun Ren and Kenton Russell (2021). formattable: Create 'Formattable' Data Structures. R package version 0.2.1. https://CRAN.R-project.org/package=formattable

- Nicholas Tierney, Di Cook, Miles McBain and Colin Fay (2021). naniar: Data Structures, Summaries, and Visualisations for Missing Data. R package version 0.6.1. https://CRAN.R-project.org/package=naniar

- Ramnath Vaidyanathan, Kent Russell and Gareth Watts (2016). sparkline: 'jQuery' Sparkline 'htmlwidget'. R package version 2.0. https://CRAN.R-project.org/package=sparkline

- Simon Garnier, Noam Ross, Robert Rudis, Antônio P. Camargo, Marco Sciaini, and Cédric Scherer (2021). Rvision - Colorblind-Friendly Color Maps for R. R package version 0.6.1.

- Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686

- Yihui Xie, Joe Cheng and Xianying Tan (2021). DT: A Wrapper of the JavaScript Library 'DataTables'. R package version 0.18. https://CRAN.R-project.org/package=DT

### Others

- Hannah Ritchie, Edouard Mathieu, Lucas Rodés-Guirao, Cameron Appel, Charlie Giattino, Esteban Ortiz-Ospina, Joe Hasell, Bobbie Macdonald, Diana Beltekian and Max Roser (2020) - "Coronavirus Pandemic (COVID-19)". Published online at OurWorldInData.org. Retrieved from: 'https://ourworldindata.org/coronavirus' [Online Resource]

- Mathieu, E., Ritchie, H., Ortiz-Ospina, E. et al. A global database of COVID-19 vaccinations. Nat Hum Behav (2021)

- Public health criteria to adjust public health and social measures in the context of COVID-19, 12 May, 2020.

